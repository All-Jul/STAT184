---
title: "Final Project"
name: "Allan E. Julian"
output: pdf_document
date: "2023-12-04"
---
# Exploring Air Quality Index in Urban vs Rural areas with an Emphasis in Centre County, PA

In the contemporary landscape, issues related to air quality have gained paramount significance, with concerns arising about the accuracy and transparency of reported air quality data. The phenomenon of air pollution, commonly attributed to common citizens , has extended its reach to encompass environmental factors, including the air we breathe. As urban and rural areas grapple with diverse environmental challenges, the need for reliable air quality information becomes increasingly crucial.

This exploration centers around a comprehensive dataset capturing daily Air Quality Index (AQI) measurements across various counties in the United States. The dataset encompasses crucial variables such as State Name, County Name, Date, AQI, Category, Defining Parameter, Defining Site, and the Number of Sites Reporting. The primary objective is to scrutinize the variations in air quality and investigate the potential impact of diverse environmental factors.

Drawing inspiration from methodologies employed in similar studies, this project leverages statistical techniques, data cleaning, and exploratory data analysis (EDA) using the R programming language. The focus is not only on discerning relationships between air quality and environmental factors but also on elucidating the complex interplay of variables that contribute to fluctuations in air quality.

As we embark on this analytical journey, the ultimate goal is to gain insights into the dynamics of air quality, allowing for a more informed understanding of the factors influencing it. Through this exploration, we aim to contribute valuable knowledge to the broader discourse on environmental health, policy-making, and public awareness

Air pollution is a major global issue that affects the health and well-being of millions of people. To help  understand the quality of air in your city. The Air Quality Index (AQI) is a widely-used measure of air pollution that provides information on the quality of air in a city on a daily basis.

The AQI calculation takes into account the levels of five major air pollutants, including ground-level ozone, particle pollution/particulate matter (PM2.5/pm 10), carbon monoxide, sulfur dioxide, and nitrogen dioxide. These pollutants can have different impacts on health, and their levels are measured to determine the overall AQI. In the United States, you can also find a ranking of air quality by state.

Suppose we have a family in which there are members that are a vulnerable population to respiratory conditions (asthma, bronchitis, etc), can we make a model to help this family choose a county to live in that would minimize the chances of environmental conditions affecting their pre-existing conditions?
 
 
#Data Exploration

As per usual with any statistical test, some data exploration needs to be done in order to get a better sense of the type of data that we are working with and to discard any innapropiate statistical test we were thinking of doing/

```{r echo=FALSE}
library(dplyr)
library(ggplot2)
library(tidyr)
library(GGally)

setwd("/Users/allan/Downloads")
file_path <- file.path("/Users/allan/Downloads", "daily_aqi_by_county_2023.csv")

air_quality_data <- read.csv(file_path)

```
Let us inspect the data to get a sense of how it looks like.
```{r echo=FALSE}
head(air_quality_data)
```
There are 10 variables, all of which are categorical except for AQI, which is continuous. We will mostly focus on the first 8, with AQI being the main character

```{r echo=FALSE}
# Load necessary libraries
library(tidyverse)
library(ggplot2)

# EDA for Categorical Variables (Defining.Parameter)
# Summary statistics and distribution of Defining.Parameters
defining_param_summary <- air_quality_data %>%
  group_by(Defining.Parameter) %>%
  summarise(
    Mean_AQI = mean(AQI),
    Median_AQI = median(AQI),
    Min_AQI = min(AQI),
    Max_AQI = max(AQI),
    Count = n()
  )

defining_param_summary
```
At a first glance, we can see that Ozone is the most common contaminant parameter, appearing in the majority of the cases, but it doesn't seem to have too much impact on AQI, PM10 and PM2.5 have alos similar means to Ozone and PM10's Max_AQI is orders of magnitude bigger than Ozone, let us inspect furter

```{r echo=FALSE}
# Bar plot of Mean AQI by Defining.Parameter
ggplot(defining_param_summary, aes(x = Defining.Parameter, y = Mean_AQI, fill = Defining.Parameter)) +
  geom_bar(stat = "identity") +
  labs(title = "Mean AQI by Defining Parameter",
       x = "Defining Parameter",
       y = "Mean AQI",
       fill = "Defining Parameter") +
  theme_minimal()
```

```{r echo=FALSE}
# Boxplot of AQI distribution by Defining.Parameter
ggplot(air_quality_data, aes(x = Defining.Parameter, y = AQI, fill = Defining.Parameter)) +
  geom_boxplot() +
  labs(title = "AQI Distribution by Defining Parameter",
       x = "Defining Parameter",
       y = "AQI",
       fill = "Defining Parameter") +
  theme_minimal()
```
As we can see, the variance of AQI within the PM10 group seems to be way higher than those from other groups, so even tho Ozone presents a higher overall mean despite being very common, I am inclined to believe that the presence of PM10 and PM2.5 have a higher impact in the overall AQI.

Let us see now what the AQI would look like in a certain Urban county and a rural one

```{r echo=FALSE}

# Filter data for New York County (NYC)
nyc_data <- air_quality_data %>%
  filter(State.Name == "New York" & county.Name == "Kings")

# Filter data for Baldwin, Alaska
fairbanks_data <- air_quality_data %>%
  filter(State.Name == "Alaska" & county.Name == "Fairbanks North Star ")

# Summary statistics for NYC and Baldwin
summary_nyc <- nyc_data %>%
  summarise(
    Mean_AQI = mean(AQI),
    Median_AQI = median(AQI),
    Max_AQI = max(AQI),
    Min_AQI = min(AQI),
    Total_Days = n()
  )

summary_fairbanks <- fairbanks_data %>%
  summarise(
    Mean_AQI = mean(AQI),
    Median_AQI = median(AQI),
    Max_AQI = max(AQI),
    Min_AQI = min(AQI),
    Total_Days = n()
  )
summary_nyc
summary_fairbanks
```

```{r echo=FALSE}
# Boxplot of AQI distribution for NYC and Baldwin
comparison_data <- rbind(
  mutate(nyc_data, Location = "NYC"),
  mutate(fairbanks_data, Location = "Fairbanks")
)

ggplot(comparison_data, aes(x = Location, y = AQI, fill = Location)) +
  geom_boxplot() +
  labs(title = "AQI Distribution: NYC vs. Fairbanks",
       x = "Location",
       y = "AQI",
       fill = "Location") +
  theme_minimal()
```

An Urban vs Rural analysis would have been insanely useful given the seemingly unintuitive results from this code snippet, unfortunately, the data does not provide us with a variable that identifies a certain county based on wether it is rural or urban. This is one of the limitations of the dataset and further analysis to answer the research question won't take into consideration the zoning (Urban or Rural), it is a handicap but there are other alternatives.



In order to get an idea of what the parameters do, let us use state college as an example. State College in June 2023, experienced one of the worst AQI's of the last decade because of the canadian wildfires, ashes are considered to be PM10 particles. In order to answer our question better, we need to see wether we can correlate the presence of wildfires or volcaninc eruptions and AQI.

Although not a formal hypothesis test, the next visualization may confirm our suspicions.

```{r}

# Filter data for Centre County, PA
centre_county_data <- air_quality_data %>%
  filter(State.Name == "Pennsylvania" & county.Name == "Centre")

# Convert Date to a date format
centre_county_data$Date <- as.Date(centre_county_data$Date)

# Aggregate data to monthly averages
monthly_avg_data <- centre_county_data %>%
  group_by(Year = lubridate::year(Date), Month = lubridate::month(Date)) %>%
  summarise(Avg_AQI = mean(AQI))

# Time series plot of Monthly Average AQI in Centre County, PA
ggplot(monthly_avg_data, aes(x = as.Date(paste(Year, Month, 1, sep = "-")), y = Avg_AQI)) +
  geom_line() +
  labs(title = "Monthly Average Air Quality in Centre County, PA",
       x = "Date",
       y = "Average AQI") +
  theme_minimal()
```
As we can see, during the of June the Averaeg AQI skyrocketed, I think we can see why PM10 is considered one of the worst contaminants out there, the level of damage it can cause is seemingly endless, despite being rare to a certain extent.

```{r}
summary_centre <- centre_county_data %>%
  summarise(
    Mean_AQI = mean(AQI),
    Median_AQI = median(AQI),
    Max_AQI = max(AQI),
    Min_AQI = min(AQI),
    Total_Days = n()
  )


summary_centre
```
State College AQI peaked at 187 during the times of the canadian wildfires that affected the Mid-Atlantic and New-England zones of the United States, further analysis could be conducted by the researcher to get exact dates.

# Statistical Tests 
```{r}
# Load necessary libraries
library(tidyverse)
library(caret)
library(randomForest)

# Data cleaning and preprocessing
subset_data <- air_quality_data 
# Convert categorical variables to factors


# Split the data into training and testing sets
set.seed(123)
train_indices <- createDataPartition(subset_data$AQI, p = 0.7, list = FALSE)
train_data <- subset_data[train_indices, ]
test_data <- subset_data[-train_indices, ]

# Random Forest model
rf_model <- randomForest(AQI ~ ., data = train_data, ntree = 5)

# Predict AQI on the test set
predictions <- predict(rf_model, newdata = test_data)

# Evaluate the model
rmse <- sqrt(mean((test_data$AQI - predictions)^2))
cat("Root Mean Squared Error (RMSE):", rmse, "\n")
```


```{r}
# Assuming you've loaded your dataset into a variable called 'air_quality_data'
# You may need to adjust the variable names based on your actual dataset

# Load necessary libraries
library(tidyverse)

# Data cleaning and preprocessing
subset_data <- air_quality_data %>%
  select(County.Code, AQI)

# Group by county code and calculate mean and median AQI
county_summary <- subset_data %>%
  group_by(County.Code) %>%
  summarise(
    Mean_AQI = mean(AQI, na.rm = TRUE),
    Median_AQI = median(AQI, na.rm = TRUE)
  ) %>%
  arrange(desc(Mean_AQI))  # Arrange by descending mean AQI

# Print the county code with the highest mean and median AQI
cat("County Code with Highest Mean AQI:", county_summary$County.Code[1], "\n")
cat("County Code with Highest Median AQI:", county_summary$County.Code[1], "\n")

ggplot(county_summary, aes(x = County.Code, y = Mean_AQI)) +
  geom_bar(stat = "identity") +
  labs(title = "Mean AQI by County Code",
       x = "County Code",
       y = "Mean AQI") +
  theme_minimal()

```

```{r}
# Load libraries
library(caret)
library(rpart)
library(rpart.plot)

# Read the dataset
data <- air_quality_data

# Convert 'Category' to a factor with consistent levels
data$Category <- as.factor(data$Category)

# Split the data into training and testing sets
set.seed(123)
train_index <- createDataPartition(data$Category, p = 0.8, list = FALSE)
train_data <- data[train_index, ]
test_data <- data[-train_index, ]

# Ensure consistent factor levels in 'Category' for both datasets
test_data$Category <- factor(test_data$Category, levels = levels(train_data$Category))

# Create a decision tree model
tree_model <- rpart(Category ~ County.Code + AQI, data = train_data, method = "class")

# Visualize the decision tree
rpart.plot(tree_model, type = 4, extra = 101, fallen.leaves = TRUE, box.col = c("#D3D3D3"))

# Make predictions on the test set
predictions <- predict(tree_model, newdata = test_data, type = "class")

# Confusion matrix
conf_matrix <- confusionMatrix(predictions, test_data$Category)
print(conf_matrix)

# Accuracy
accuracy <- conf_matrix$overall["Accuracy"]
print(paste("Accuracy:", accuracy))

```

```{r}

```

```{r}
library(randomForest)

rf_model <- randomForest(Category ~ County.Code + AQI, data = data, ntree = 100)

# Print the random forest summary
print(rf_model)
```

```{r}
library(nnet)
multinomial_model <- nnet::multinom(Category ~ County.Code + AQI, data = data)

# Print the summary of the multinomial model
summary(multinomial_model)
```

```{r}
air_quality_data <- data[data$AQI >= 301, ]

# Create a frequency table
frequency_table <- table(air_quality_data$State.Name)

frequency_df <- as.data.frame(frequency_table)

# Rename the columns
colnames(frequency_df) <- c("County", "Frequency")

# Sort the data frame by Frequency in descending order
frequency_df <- frequency_df[order(-frequency_df$Frequency), ]

# Print the nicely formatted frequency table
print(
  knitr::kable(
    frequency_df,
    caption = "Frequency Table of Counties with AQI >= 301",
    col.names = c("County", "Frequency"),
    align = "c"
  )
)
```


```{r}
d$Defining.Parameter <- as.factor(d$Defining.Parameter)

# Create dummy variables for 'Defining.Parameter'
dummy_vars <- model.matrix(~ Defining.Parameter - 1, data = d)

# Combine the dummy variables with the original dataset
d <- cbind(d, dummy_vars)

# Fit a linear model with dummy variables
linear_model <- lm(AQI ~ ., data = d)

# Print the summary of the linear model
print(summary(linear_model))
```





